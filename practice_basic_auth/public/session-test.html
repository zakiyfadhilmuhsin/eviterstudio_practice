<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Management Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">Session Management Test</h1>

        <!-- Login Section -->
        <div class="max-w-md mx-auto mb-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Login untuk Test</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" value="test@example.com">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" value="password123">
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">
                    Login
                </button>
            </form>
            <div id="loginResult" class="mt-4"></div>
        </div>

        <!-- Session Management Section -->
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6" id="sessionSection" style="display: none;">
            <h2 class="text-xl font-semibold mb-4">Session Management</h2>

            <!-- Session Stats -->
            <div id="sessionStats" class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold text-gray-700 mb-2">Session Statistics</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div class="text-center">
                        <div class="font-bold text-blue-600" id="totalActive">-</div>
                        <div class="text-gray-600">Active Sessions</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-green-600" id="totalDevices">-</div>
                        <div class="text-gray-600">Devices</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-orange-600" id="recentLogins">-</div>
                        <div class="text-gray-600">Recent Logins</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-purple-600" id="oldestSession">-</div>
                        <div class="text-gray-600">Oldest Session</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="mb-6 flex gap-4">
                <button id="loadSessions" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                    üîÑ Load Sessions
                </button>
                <button id="revokeAllSessions" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                    ‚ö†Ô∏è Revoke All Sessions
                </button>
            </div>

            <!-- Sessions List -->
            <div id="sessionsList">
                <div class="text-gray-500 text-center py-8">
                    Click "Load Sessions" to view active sessions
                </div>
            </div>
        </div>

        <!-- API Response Section -->
        <div class="max-w-4xl mx-auto mt-8 bg-gray-800 text-green-400 rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4">API Response Log</h3>
            <div id="apiLog" class="text-xs font-mono max-h-64 overflow-y-auto">
                Ready for testing...
            </div>
        </div>
    </div>

    <script>
        let authToken = null;

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('http://localhost:3018/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                logApiResponse('POST /auth/login', response.status, result);

                if (response.ok && result.access_token) {
                    authToken = result.access_token;
                    document.getElementById('loginResult').innerHTML =
                        '<div class="text-green-600 font-semibold">‚úÖ Login successful!</div>';
                    document.getElementById('sessionSection').style.display = 'block';
                } else {
                    document.getElementById('loginResult').innerHTML =
                        '<div class="text-red-600 font-semibold">‚ùå Login failed: ' +
                        (result.message || 'Unknown error') + '</div>';
                }
            } catch (error) {
                logApiResponse('POST /auth/login', 'ERROR', { error: error.message });
                document.getElementById('loginResult').innerHTML =
                    '<div class="text-red-600 font-semibold">‚ùå Network error</div>';
            }
        });

        // Load sessions
        document.getElementById('loadSessions').addEventListener('click', async () => {
            if (!authToken) {
                alert('Please login first');
                return;
            }

            try {
                const response = await fetch('http://localhost:3018/auth/sessions', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                logApiResponse('GET /auth/sessions', response.status, result);

                if (response.ok) {
                    displaySessions(result.data || []);
                    displayStats(result.stats || {});
                } else {
                    alert('Failed to load sessions: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                logApiResponse('GET /auth/sessions', 'ERROR', { error: error.message });
                alert('Network error');
            }
        });

        // Revoke all sessions
        document.getElementById('revokeAllSessions').addEventListener('click', async () => {
            if (!authToken) {
                alert('Please login first');
                return;
            }

            if (!confirm('Are you sure you want to revoke all other sessions?')) {
                return;
            }

            try {
                const response = await fetch('http://localhost:3018/auth/sessions/all', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                logApiResponse('DELETE /auth/sessions/all', response.status, result);

                if (response.ok) {
                    alert('‚úÖ All other sessions revoked: ' + result.revokedCount + ' sessions');
                    // Reload sessions
                    document.getElementById('loadSessions').click();
                } else {
                    alert('Failed to revoke sessions: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                logApiResponse('DELETE /auth/sessions/all', 'ERROR', { error: error.message });
                alert('Network error');
            }
        });

        // Revoke specific session
        async function revokeSession(sessionId) {
            if (!authToken) {
                alert('Please login first');
                return;
            }

            if (!confirm('Are you sure you want to revoke this session?')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3018/auth/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                logApiResponse(`DELETE /auth/sessions/${sessionId}`, response.status, result);

                if (response.ok) {
                    alert('‚úÖ Session revoked successfully');
                    // Reload sessions
                    document.getElementById('loadSessions').click();
                } else {
                    alert('Failed to revoke session: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                logApiResponse(`DELETE /auth/sessions/${sessionId}`, 'ERROR', { error: error.message });
                alert('Network error');
            }
        }

        // Display sessions
        function displaySessions(sessions) {
            const container = document.getElementById('sessionsList');

            if (sessions.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-8">No active sessions found</div>';
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="border rounded-lg p-4 mb-4 ${session.current ? 'border-green-400 bg-green-50' : 'border-gray-200'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h4 class="font-semibold text-gray-800">${session.device}</h4>
                                ${session.current ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Current Session</span>' : ''}
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <div>üìç Location: ${session.location || 'Unknown'}</div>
                                <div>üåê IP: ${session.ipAddress}</div>
                                <div>üïí Last Active: ${new Date(session.lastActive).toLocaleString()}</div>
                                <div>üìÖ Created: ${new Date(session.createdAt).toLocaleString()}</div>
                                <div>‚è∞ Expires: ${new Date(session.expiresAt).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="ml-4">
                            ${!session.current ? `
                                <button onclick="revokeSession('${session.id}')"
                                        class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                    Revoke
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Display stats
        function displayStats(stats) {
            document.getElementById('totalActive').textContent = stats.totalActive || 0;
            document.getElementById('totalDevices').textContent = stats.totalDevices || 0;
            document.getElementById('recentLogins').textContent = stats.recentLogins || 0;
            document.getElementById('oldestSession').textContent =
                stats.oldestSession ? new Date(stats.oldestSession).toLocaleDateString() : 'N/A';
        }

        // Log API responses
        function logApiResponse(endpoint, status, data) {
            const logElement = document.getElementById('apiLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${endpoint} - Status: ${status}\n${JSON.stringify(data, null, 2)}\n\n`;
            logElement.textContent = logEntry + logElement.textContent;
        }
    </script>
</body>
</html>