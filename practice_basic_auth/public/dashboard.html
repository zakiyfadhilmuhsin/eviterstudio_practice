<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Practice Auth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./auth-utils.js"></script>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: https:;">
    <meta name="robots" content="noindex, nofollow">
    <meta name="referrer" content="strict-origin-when-cross-origin">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation Header -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900">üîê Practice Auth Dashboard</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button id="profileMenuButton" class="flex items-center space-x-2 text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-md p-1">
                            <img id="userAvatar" class="h-8 w-8 rounded-full" src="" alt="Profile" style="display: none;">
                            <div id="userInitials" class="h-8 w-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-medium"></div>
                            <span id="userName" class="text-sm font-medium">Loading...</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="profileMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 border">
                            <a href="#" onclick="showProfile()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">üë§ View Profile</a>
                            <a href="#" onclick="showSessions()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">üñ•Ô∏è Active Sessions</a>
                            <a href="#" onclick="showSecurity()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">üîí Security</a>
                            <div class="border-t border-gray-100"></div>
                            <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">üö™ Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Welcome Section -->
        <div class="bg-white overflow-hidden shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <img id="welcomeAvatar" class="h-16 w-16 rounded-full" src="" alt="Profile" style="display: none;">
                        <div id="welcomeInitials" class="h-16 w-16 bg-blue-600 rounded-full flex items-center justify-center text-white text-xl font-medium"></div>
                    </div>
                    <div class="ml-4">
                        <h2 class="text-2xl font-bold text-gray-900">Welcome back, <span id="welcomeName">User</span>! üëã</h2>
                        <p class="text-gray-600">You're successfully authenticated via Google OAuth</p>
                        <div class="mt-2 flex items-center text-sm text-gray-500">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Last login: <span id="lastLogin">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            <!-- Profile Card -->
            <div class="bg-white overflow-hidden shadow rounded-lg cursor-pointer hover:shadow-md transition-shadow" onclick="showProfile()">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Profile Information</dt>
                                <dd class="text-lg font-medium text-gray-900">View & Edit</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sessions Card -->
            <div class="bg-white overflow-hidden shadow rounded-lg cursor-pointer hover:shadow-md transition-shadow" onclick="showSessions()">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Active Sessions</dt>
                                <dd class="text-lg font-medium text-gray-900" id="sessionCount">Loading...</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Card -->
            <div class="bg-white overflow-hidden shadow rounded-lg cursor-pointer hover:shadow-md transition-shadow" onclick="showSecurity()">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Security Status</dt>
                                <dd class="text-lg font-medium text-gray-900" id="securityStatus">Checking...</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Sections -->
        <div id="contentSection">
            <!-- Default Dashboard View -->
            <div id="defaultView" class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Account Overview</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Authentication Method</h4>
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                <span class="text-sm text-gray-900">Google OAuth 2.0</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Secure</span>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Session Security</h4>
                            <div class="space-y-1">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Token Expiration</span>
                                    <span id="tokenExpiration" class="text-gray-900">Loading...</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">HTTPS Enabled</span>
                                    <span class="text-green-600">‚úì Yes</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">CSRF Protection</span>
                                    <span class="text-green-600">‚úì Active</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile View -->
            <div id="profileView" class="hidden bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-medium text-gray-900">Profile Information</h3>
                        <button onclick="showDefault()" class="text-blue-600 hover:text-blue-800 text-sm">‚Üê Back to Dashboard</button>
                    </div>
                    <div id="profileData" class="space-y-4">
                        <!-- Profile data will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Sessions View -->
            <div id="sessionsView" class="hidden bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-medium text-gray-900">Active Sessions</h3>
                        <button onclick="showDefault()" class="text-blue-600 hover:text-blue-800 text-sm">‚Üê Back to Dashboard</button>
                    </div>
                    <div id="sessionsData">
                        <!-- Sessions data will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Security View -->
            <div id="securityView" class="hidden bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-medium text-gray-900">Security Status</h3>
                        <button onclick="showDefault()" class="text-blue-600 hover:text-blue-800 text-sm">‚Üê Back to Dashboard</button>
                    </div>
                    <div id="securityData">
                        <!-- Security data will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <span class="text-gray-700" id="loadingText">Loading...</span>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Confirm Logout</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to sign out? You'll need to authenticate again to access your account.</p>
                <div class="flex space-x-3">
                    <button onclick="hideLogoutModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
                    <button onclick="confirmLogout()" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const LOGIN_URL = './google-login.html';

        // State
        let currentUser = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication using secure utilities
            if (!TokenManager.isTokenValid()) {
                redirectToLogin();
                return;
            }

            // Load user data
            await loadUserProfile();
            await loadDashboardData();

            // Setup event listeners
            setupEventListeners();
        });

        // Load user profile
        async function loadUserProfile() {
            try {
                showLoading(true, 'Loading profile...');
                currentUser = await SecureAPIClient.get('/auth/profile');
                updateUserDisplay();
            } catch (error) {
                console.error('Failed to load profile:', error);
                UISecurityHelpers.showSecurityMessage('Failed to load profile data', 'error');
                if (error.message === 'No valid authentication token') {
                    redirectToLogin();
                }
            } finally {
                showLoading(false);
            }
        }

        // Update user display
        function updateUserDisplay() {
            if (!currentUser) return;

            const profile = currentUser.profile || currentUser;
            const firstName = profile.firstName || profile.name?.split(' ')[0] || 'User';
            const lastName = profile.lastName || profile.name?.split(' ')[1] || '';
            const fullName = `${firstName} ${lastName}`.trim();
            const email = profile.email || currentUser.email;
            const avatar = profile.avatar || profile.picture;

            // Update navigation
            document.getElementById('userName').textContent = firstName;
            document.getElementById('welcomeName').textContent = firstName;

            // Update avatars
            const initials = `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
            document.getElementById('userInitials').textContent = initials;
            document.getElementById('welcomeInitials').textContent = initials;

            if (avatar) {
                document.getElementById('userAvatar').src = avatar;
                document.getElementById('userAvatar').style.display = 'block';
                document.getElementById('userInitials').style.display = 'none';

                document.getElementById('welcomeAvatar').src = avatar;
                document.getElementById('welcomeAvatar').style.display = 'block';
                document.getElementById('welcomeInitials').style.display = 'none';
            }

            // Update last login
            if (currentUser.lastLoginAt) {
                document.getElementById('lastLogin').textContent = new Date(currentUser.lastLoginAt).toLocaleString();
            }

            // Update token expiration
            const expiration = TokenManager.getTokenExpiration();
            if (expiration) {
                document.getElementById('tokenExpiration').textContent = expiration.toLocaleTimeString();
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            await Promise.all([
                loadSessionCount(),
                loadSecurityStatus()
            ]);
        }

        // Load session count
        async function loadSessionCount() {
            try {
                const data = await SecureAPIClient.get('/auth/sessions');
                const count = data.data?.length || 0;
                document.getElementById('sessionCount').textContent = `${count} Active`;
            } catch (error) {
                document.getElementById('sessionCount').textContent = 'Error';
            }
        }

        // Load security status
        async function loadSecurityStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/security/status`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    document.getElementById('securityStatus').textContent = 'Secure';
                } else {
                    document.getElementById('securityStatus').textContent = 'Warning';
                }
            } catch (error) {
                document.getElementById('securityStatus').textContent = 'Error';
            }
        }

        // Navigation functions
        function showProfile() {
            hideAllViews();
            document.getElementById('profileView').classList.remove('hidden');
            loadProfileData();
        }

        function showSessions() {
            hideAllViews();
            document.getElementById('sessionsView').classList.remove('hidden');
            loadSessionsData();
        }

        function showSecurity() {
            hideAllViews();
            document.getElementById('securityView').classList.remove('hidden');
            loadSecurityData();
        }

        function showDefault() {
            hideAllViews();
            document.getElementById('defaultView').classList.remove('hidden');
        }

        function hideAllViews() {
            document.getElementById('defaultView').classList.add('hidden');
            document.getElementById('profileView').classList.add('hidden');
            document.getElementById('sessionsView').classList.add('hidden');
            document.getElementById('securityView').classList.add('hidden');
        }

        // Load detailed data
        async function loadProfileData() {
            const container = document.getElementById('profileData');

            if (!currentUser) {
                container.innerHTML = '<p class="text-gray-500">No profile data available</p>';
                return;
            }

            const profile = currentUser.profile || currentUser;

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Full Name</label>
                        <p class="mt-1 text-sm text-gray-900">${profile.firstName || 'N/A'} ${profile.lastName || ''}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <p class="mt-1 text-sm text-gray-900">${profile.email || currentUser.email || 'N/A'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Provider</label>
                        <p class="mt-1 text-sm text-gray-900">Google OAuth</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Account Status</label>
                        <p class="mt-1 text-sm text-green-600">‚úì Active & Verified</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Member Since</label>
                        <p class="mt-1 text-sm text-gray-900">${currentUser.createdAt ? new Date(currentUser.createdAt).toLocaleDateString() : 'N/A'}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Last Login</label>
                        <p class="mt-1 text-sm text-gray-900">${currentUser.lastLoginAt ? new Date(currentUser.lastLoginAt).toLocaleString() : 'N/A'}</p>
                    </div>
                </div>
            `;
        }

        async function loadSessionsData() {
            const container = document.getElementById('sessionsData');

            try {
                showLoading(true, 'Loading sessions...');

                const response = await fetch(`${API_BASE_URL}/auth/sessions`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                alert(JSON.stringify(response));

                if (!response.ok) {
                    throw new Error('Failed to load sessions');
                }

                const data = await response.json();
                const sessions = data.data || [];

                if (sessions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No active sessions found</p>';
                    return;
                }

                container.innerHTML = sessions.map(session => `
                    <div class="border rounded-lg p-4 mb-4 ${session.current ? 'border-green-400 bg-green-50' : 'border-gray-200'}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <h4 class="font-semibold text-gray-800">${session.device || 'Unknown Device'}</h4>
                                    ${session.current ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Current Session</span>' : ''}
                                </div>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div>üåê IP: ${session.ipAddress || 'Unknown'}</div>
                                    <div>üïí Last Active: ${session.lastActive ? new Date(session.lastActive).toLocaleString() : 'N/A'}</div>
                                    <div>üìÖ Created: ${session.createdAt ? new Date(session.createdAt).toLocaleString() : 'N/A'}</div>
                                </div>
                            </div>
                            ${!session.current ? `
                                <button onclick="revokeSession('${session.id}')"
                                        class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                    Revoke
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                container.innerHTML = '<p class="text-red-500">Failed to load sessions</p>';
            } finally {
                showLoading(false);
            }
        }

        async function loadSecurityData() {
            const container = document.getElementById('securityData');

            try {
                showLoading(true, 'Loading security data...');

                const response = await fetch(`${API_BASE_URL}/auth/security/status`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load security data');
                }

                const data = await response.json();

                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-medium text-green-800 mb-2">‚úÖ Account Security Status</h4>
                            <div class="text-sm text-green-700 space-y-1">
                                <div>‚Ä¢ Account is not locked</div>
                                <div>‚Ä¢ No recent failed login attempts</div>
                                <div>‚Ä¢ OAuth authentication active</div>
                                <div>‚Ä¢ Secure HTTPS connection</div>
                            </div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-medium text-blue-800 mb-2">üîí Security Features</h4>
                            <div class="text-sm text-blue-700 space-y-1">
                                <div>‚Ä¢ CSRF protection enabled</div>
                                <div>‚Ä¢ XSS protection headers</div>
                                <div>‚Ä¢ Rate limiting active</div>
                                <div>‚Ä¢ Session timeout configured</div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h4 class="font-medium text-yellow-800 mb-2">‚ö†Ô∏è Security Recommendations</h4>
                            <div class="text-sm text-yellow-700 space-y-1">
                                <div>‚Ä¢ Regularly review active sessions</div>
                                <div>‚Ä¢ Use strong, unique passwords</div>
                                <div>‚Ä¢ Keep browser updated</div>
                                <div>‚Ä¢ Enable 2FA when available</div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                container.innerHTML = '<p class="text-red-500">Failed to load security data</p>';
            } finally {
                showLoading(false);
            }
        }

        // Session management
        async function revokeSession(sessionId) {
            if (!confirm('Are you sure you want to revoke this session?')) {
                return;
            }

            try {
                showLoading(true, 'Revoking session...');

                const response = await fetch(`${API_BASE_URL}/auth/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    showSuccessMessage('Session revoked successfully');
                    loadSessionsData(); // Reload sessions
                } else {
                    throw new Error('Failed to revoke session');
                }
            } catch (error) {
                showErrorMessage('Failed to revoke session');
            } finally {
                showLoading(false);
            }
        }

        // Logout functionality
        function logout() {
            document.getElementById('logoutModal').classList.remove('hidden');
        }

        function hideLogoutModal() {
            document.getElementById('logoutModal').classList.add('hidden');
        }

        async function confirmLogout() {
            hideLogoutModal();

            try {
                showLoading(true, 'Logging out...');
                await AuthFlowManager.logout();
                window.location.href = LOGIN_URL;
            } catch (error) {
                // Logout should always succeed locally
                window.location.href = LOGIN_URL;
            }
        }

        // Event listeners
        function setupEventListeners() {
            // Profile menu toggle
            document.getElementById('profileMenuButton').addEventListener('click', function() {
                const menu = document.getElementById('profileMenu');
                menu.classList.toggle('hidden');
            });

            // Close profile menu when clicking outside
            document.addEventListener('click', function(event) {
                const menu = document.getElementById('profileMenu');
                const button = document.getElementById('profileMenuButton');

                if (!menu.contains(event.target) && !button.contains(event.target)) {
                    menu.classList.add('hidden');
                }
            });

            // Auto-refresh token before expiration
            setInterval(checkTokenExpiration, 60000); // Check every minute
        }

        // Token management
        function checkTokenExpiration() {
            const expiration = sessionStorage.getItem('tokenExpiration');
            if (!expiration) return;

            const timeLeft = parseInt(expiration) - Date.now();
            const fiveMinutes = 5 * 60 * 1000;

            if (timeLeft <= fiveMinutes && timeLeft > 0) {
                showWarningMessage('Your session will expire soon. Please save your work.');
            } else if (timeLeft <= 0) {
                showErrorMessage('Your session has expired. Redirecting to login...');
                setTimeout(() => {
                    redirectToLogin();
                }, 2000);
            }
        }

        // Utility functions
        function redirectToLogin() {
            TokenManager.clearToken();
            window.location.href = LOGIN_URL;
        }

        function showLoading(show, text = 'Loading...') {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
            document.getElementById('loadingText').textContent = text;
        }

        function showSuccessMessage(message) {
            // Simple success message - could be enhanced with toast notifications
            alert('‚úÖ ' + message);
        }

        function showErrorMessage(message) {
            // Simple error message - could be enhanced with toast notifications
            alert('‚ùå ' + message);
        }

        function showWarningMessage(message) {
            // Simple warning message - could be enhanced with toast notifications
            alert('‚ö†Ô∏è ' + message);
        }

        // Security: Clear sensitive data on page unload
        window.addEventListener('beforeunload', function() {
            // Clear any temporary data
            if (window.tempData) {
                delete window.tempData;
            }
        });
    </script>
</body>
</html>